import { Command } from 'commander'
import { createWriteStream } from 'fs'
import transformers, { type TransformerInformation } from './transformers.js'

const program = new Command()

program.name('discordeno').description('CLI to discordeno utilities').version('0.1.0')

program
  .command('generate')
  .description('Generate types/schema for discordeno')
  .action(async () => {
    const file = createWriteStream('transformers.generated.ts', { encoding: 'utf-8' })

    file.write('/* eslint-disable */\n')
    file.write('// <auto-generated/>\n\n')

    for (const structure of Object.values(transformers)) {
      file.write(`export interface ${structure.name} ${parseStructureProprieties(structure.proprieties)}\n\n`)
    }

    file.close()
  })

program.parse()

function parseStructureProprieties(proprieties: TransformerInformation['proprieties'] | string, intent: number = 2): string {
  if (typeof proprieties === 'string') return proprieties

  const spaces = ' '.repeat(intent)

  let result = '{\n'

  for (const [propName, prop] of Object.entries(proprieties)) {
    if (prop.comment) {
      result += `${spaces}/**\n`
      const splittedComment = prop.comment.split('\n')

      if (splittedComment.at(0) === '') splittedComment.shift()
      if (splittedComment.at(-1) === '') splittedComment.pop()

      for (const commentLine of splittedComment) {
        result += `${spaces} * ${commentLine}\n`
      }

      result += `${spaces} */\n`
    }

    const type = prop.array ? `Array<${parseStructureProprieties(prop.type, intent * 2)}>` : parseStructureProprieties(prop.type, intent * 2)

    result += `${spaces}${propName}${prop.optional ? '?' : ''}: ${type}\n`
  }

  result += `${' '.repeat(intent - 2)}}`

  return result
}
